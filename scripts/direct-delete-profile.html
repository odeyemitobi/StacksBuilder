<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Profile Deletion</title>
    <script src="https://unpkg.com/@stacks/connect@21.3.0/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@stacks/transactions@6.13.1/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@stacks/network@6.13.1/dist/umd/index.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .delete-btn {
            background: #dc3545;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Direct Profile Deletion Tool</h1>
        <p>This tool directly calls the <code>delete-profile</code> function on the deployed testnet contract.</p>
        
        <div id="status" class="status info">
            <strong>Status:</strong> Ready to connect wallet
        </div>

        <div>
            <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
            <button id="checkBtn" onclick="checkProfile()" disabled>Check Profile</button>
            <button id="deleteBtn" onclick="deleteProfile()" disabled class="delete-btn">Delete Profile</button>
        </div>

        <div id="profileInfo" style="margin-top: 20px;"></div>
    </div>

    <script>
        // Wait for libraries to load
        window.addEventListener('load', function() {
            if (typeof StacksConnect === 'undefined' || typeof StacksTransactions === 'undefined' || typeof StacksNetwork === 'undefined') {
                updateStatus('Error: Stacks libraries failed to load. Please refresh the page.', 'error');
                return;
            }
            updateStatus('Ready to connect wallet', 'info');
        });

        const CONTRACT_ADDRESS = 'ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM';
        const CONTRACT_NAME = 'developer-profiles';
        let NETWORK;

        let userAddress = null;
        let isConnected = false;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
            statusDiv.className = `status ${type}`;
        }

        async function connectWallet() {
            try {
                if (typeof StacksConnect === 'undefined') {
                    updateStatus('Error: StacksConnect library not loaded', 'error');
                    return;
                }

                NETWORK = new StacksNetwork.StacksTestnet();
                updateStatus('Connecting wallet...', 'info');

                const authResponse = await StacksConnect.showConnect({
                    appDetails: {
                        name: 'Profile Deletion Tool',
                        icon: window.location.origin + '/favicon.ico',
                    },
                    redirectTo: window.location.origin,
                    onFinish: (data) => {
                        userAddress = data.userSession.loadUserData().profile.stxAddress.testnet;
                        isConnected = true;
                        
                        updateStatus(`Connected: ${userAddress}`, 'success');
                        
                        document.getElementById('connectBtn').disabled = true;
                        document.getElementById('checkBtn').disabled = false;
                        document.getElementById('deleteBtn').disabled = false;
                    },
                    onCancel: () => {
                        updateStatus('Connection cancelled', 'warning');
                    },
                });
            } catch (error) {
                updateStatus(`Connection failed: ${error.message}`, 'error');
            }
        }

        async function checkProfile() {
            if (!isConnected || !userAddress) {
                updateStatus('Please connect wallet first', 'warning');
                return;
            }

            try {
                updateStatus('Checking profile...', 'info');

                const functionArgs = [StacksTransactions.standardPrincipalCV(userAddress)];
                
                const result = await StacksTransactions.callReadOnlyFunction({
                    contractAddress: CONTRACT_ADDRESS,
                    contractName: CONTRACT_NAME,
                    functionName: 'profile-exists',
                    functionArgs: functionArgs,
                    network: NETWORK,
                    senderAddress: userAddress,
                });

                const exists = StacksTransactions.cvToValue(result);
                
                if (exists) {
                    updateStatus('‚úÖ Profile found on blockchain - ready to delete', 'success');
                    
                    // Get profile data
                    const profileResult = await StacksTransactions.callReadOnlyFunction({
                        contractAddress: CONTRACT_ADDRESS,
                        contractName: CONTRACT_NAME,
                        functionName: 'get-profile',
                        functionArgs: functionArgs,
                        network: NETWORK,
                        senderAddress: userAddress,
                    });

                    const profileData = StacksTransactions.cvToValue(profileResult);
                    document.getElementById('profileInfo').innerHTML = `
                        <h3>Profile Data:</h3>
                        <pre>${JSON.stringify(profileData, null, 2)}</pre>
                    `;
                } else {
                    updateStatus('‚ùå No profile found on blockchain', 'warning');
                    document.getElementById('profileInfo').innerHTML = '';
                }
            } catch (error) {
                updateStatus(`Error checking profile: ${error.message}`, 'error');
            }
        }

        async function deleteProfile() {
            if (!isConnected || !userAddress) {
                updateStatus('Please connect wallet first', 'warning');
                return;
            }

            if (!confirm('Are you sure you want to delete your profile? This action cannot be undone.')) {
                return;
            }

            try {
                updateStatus('Deleting profile...', 'info');

                const txOptions = {
                    contractAddress: CONTRACT_ADDRESS,
                    contractName: CONTRACT_NAME,
                    functionName: 'delete-profile',
                    functionArgs: [], // No arguments needed
                    network: NETWORK,
                    anchorMode: StacksTransactions.AnchorMode.Any,
                    postConditionMode: StacksTransactions.PostConditionMode.Allow,
                };

                await StacksConnect.openContractCall(txOptions);
                
                updateStatus('Delete transaction submitted! Check your wallet for confirmation.', 'success');
                
                // Check profile again after a delay
                setTimeout(() => {
                    checkProfile();
                }, 5000);
                
            } catch (error) {
                updateStatus(`Error deleting profile: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
